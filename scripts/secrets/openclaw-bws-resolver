#!/usr/bin/env node
//
// OpenClaw SecretRef exec resolver for Bitwarden Secrets (bws).
// Protocol v1: reads JSON from stdin, returns JSON on stdout.
//

import { execFileSync } from "node:child_process";

const BWS = process.env.BWS_BIN?.trim() || "bws";

async function main() {
  let input = "";
  for await (const chunk of process.stdin) input += chunk;

  const req = JSON.parse(input);
  if (req.protocolVersion !== 1) {
    process.stderr.write(`unsupported protocol version: ${req.protocolVersion}\n`);
    process.exit(1);
  }

  const ids = req.ids || [];
  if (ids.length === 0) {
    process.stdout.write(JSON.stringify({ protocolVersion: 1, values: {} }));
    return;
  }

  if (!process.env.BWS_ACCESS_TOKEN) {
    process.stderr.write("BWS_ACCESS_TOKEN is required\n");
    process.exit(1);
  }

  let secrets;
  try {
    const raw = execFileSync(BWS, ["secret", "list"], {
      env: { BWS_ACCESS_TOKEN: process.env.BWS_ACCESS_TOKEN, PATH: process.env.PATH || "" },
      timeout: 15000,
      maxBuffer: 1024 * 1024,
      encoding: "utf8",
    });
    secrets = JSON.parse(raw);
  } catch (err) {
    process.stderr.write(`bws secret list failed: ${err.message}\n`);
    process.exit(1);
  }

  const keyMap = {};
  for (const s of secrets) keyMap[s.key] = s.value;

  const values = {};
  const errors = {};
  for (const id of ids) {
    if (id in keyMap) values[id] = keyMap[id];
    else errors[id] = { message: `secret key "${id}" not found in BWS` };
  }

  process.stdout.write(JSON.stringify({ protocolVersion: 1, values, errors }));
}

main().catch((err) => {
  process.stderr.write(`resolver error: ${err.message}\n`);
  process.exit(1);
});
