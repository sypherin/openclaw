import { Command } from "commander";
import { beforeEach, describe, expect, it, vi } from "vitest";
import type { BrowserParentOpts } from "./browser-cli-shared.js";
import { registerBrowserStateCommands } from "./browser-cli-state.js";

const mocks = vi.hoisted(() => ({
  callBrowserRequest: vi.fn(async () => ({ ok: true })),
  runBrowserResizeWithOutput: vi.fn(async () => {}),
  runtime: {
    log: vi.fn(),
    error: vi.fn(),
    exit: vi.fn(),
  },
}));

vi.mock("./browser-cli-shared.js", () => ({
  callBrowserRequest: (...args: unknown[]) => mocks.callBrowserRequest(...args),
}));

vi.mock("./browser-cli-resize.js", () => ({
  runBrowserResizeWithOutput: (params: unknown) => mocks.runBrowserResizeWithOutput(params),
}));

vi.mock("../runtime.js", () => ({
  defaultRuntime: mocks.runtime,
}));

describe("browser state option collisions", () => {
  beforeEach(() => {
    mocks.callBrowserRequest.mockClear();
    mocks.runBrowserResizeWithOutput.mockClear();
    mocks.runtime.log.mockClear();
    mocks.runtime.error.mockClear();
    mocks.runtime.exit.mockClear();
  });

  it("forwards parent-captured --target-id on `browser cookies set`", async () => {
    const program = new Command();
    const browser = program
      .command("browser")
      .option("--browser-profile <name>", "Browser profile")
      .option("--json", "Output JSON", false);

    const parentOpts = (cmd: Command) => cmd.parent?.opts?.() as BrowserParentOpts;
    registerBrowserStateCommands(browser, parentOpts);

    await program.parseAsync(
      [
        "browser",
        "cookies",
        "set",
        "session",
        "abc",
        "--url",
        "https://example.com",
        "--target-id",
        "tab-1",
      ],
      { from: "user" },
    );

    const call = mocks.callBrowserRequest.mock.calls.at(-1);
    expect(call).toBeDefined();
    const request = call?.[1] as { body?: { targetId?: string } };
    expect(request.body?.targetId).toBe("tab-1");
  });

  it("accepts legacy `browser set headers --json <payload>` via positional fallback", async () => {
    const program = new Command();
    const browser = program
      .command("browser")
      .option("--browser-profile <name>", "Browser profile")
      .option("--json", "Output JSON", false);

    const parentOpts = (cmd: Command) => cmd.parent?.opts?.() as BrowserParentOpts;
    registerBrowserStateCommands(browser, parentOpts);

    await program.parseAsync(["browser", "set", "headers", "--json", '{"x-auth":"ok"}'], {
      from: "user",
    });

    const call = mocks.callBrowserRequest.mock.calls.at(-1);
    expect(call).toBeDefined();
    const request = call?.[1] as { body?: { headers?: Record<string, string> } };
    expect(request.body?.headers).toEqual({ "x-auth": "ok" });
  });
});
